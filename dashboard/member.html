<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Görev Takip Sistemi - Ekip Üyesi</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="brand-container">
      <div class="brand-logo">T</div>
      <h4 class="brand-name">TaskTrack</h4>
    </div>

    <div class="menu-container">
      <ul class="nav-menu">
        <li class="menu-item active">
          <a href="./member.html">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="../tasks/my-tasks.html">
            <i class="bi bi-list-task"></i>
            <span>Görevlerim</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="../projects/my-projects.html">
            <i class="bi bi-kanban"></i>
            <span>Projelerim</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="#" id="logoutBtn">
            <i class="bi bi-box-arrow-right"></i>
            <span>Çıkış Yap</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="menu-toggle" id="menu-toggle">
        <i class="bi bi-list"></i>
      </div>

      <div class="header-right">
        <div class="notifications">
          <i class="bi bi-bell"></i>
          <span class="badge">2</span>
        </div>

        <div class="user-profile" onclick="window.location.href='../profile/index.html';" style="cursor: pointer;">
          <div class="profile-img">
            <span>U</span>
          </div>
          <div class="profile-info">
            <span class="user-name">User</span>
            <span class="user-role">Ekip Üyesi</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="content-container">
      <!-- Sayfa başlığı -->
      <div class="content-header">
        <h2 class="page-title">Ekip Üyesi Dashboard</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Ana Sayfa</a></li>
            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
          </ol>
        </nav>
      </div>

      <!-- Bilgi Kartları -->
      <div class="row">
        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-primary">
                <i class="bi bi-kanban-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Dahil Olduğum Projeler</h5>
                <h3 class="stats-card-value">2</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-warning">
                <i class="bi bi-list-task"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Bekleyen Görevlerim</h5>
                <h3 class="stats-card-value">3</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-success">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Tamamlanan Görevlerim</h5>
                <h3 class="stats-card-value">8</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-info">
                <i class="bi bi-clock-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Toplam Çalışma Süresi</h5>
                <h3 class="stats-card-value">42s</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aktif Görevler -->
      <div class="row">
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Aktif Görevlerim</h5>
              <a href="../tasks/my-tasks.html" class="btn btn-sm btn-primary">Tümünü Gör</a>
            </div>
            <div class="card-body">
              <div class="task-list">
                <!-- Görev 1 -->
                <div class="task-item">
                  <div class="task-priority high"></div>
                  <div class="task-content">
                    <h6 class="task-title">Frontend Geliştirme - Giriş Sayfası</h6>
                    <div class="task-details">
                      <span class="task-project"><i class="bi bi-kanban"></i> Web Sitesi Yenileme</span>
                      <span class="task-deadline"><i class="bi bi-calendar-event"></i> 20 Mayıs 2025</span>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                  <div class="task-actions">
                    <a href="#" class="btn btn-sm btn-success" title="Tamamla"><i class="bi bi-check-lg"></i></a>
                    <a href="#" class="btn btn-sm btn-primary" title="Güncelle"><i class="bi bi-pencil"></i></a>
                  </div>
                </div>

                <!-- Görev 2 -->
                <div class="task-item">
                  <div class="task-priority medium"></div>
                  <div class="task-content">
                    <h6 class="task-title">Responsive Tasarım Düzenlemeleri</h6>
                    <div class="task-details">
                      <span class="task-project"><i class="bi bi-kanban"></i> Web Sitesi Yenileme</span>
                      <span class="task-deadline"><i class="bi bi-calendar-event"></i> 25 Mayıs 2025</span>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                      <div class="progress-bar bg-info" role="progressbar" style="width: 30%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                  <div class="task-actions">
                    <a href="#" class="btn btn-sm btn-success" title="Tamamla"><i class="bi bi-check-lg"></i></a>
                    <a href="#" class="btn btn-sm btn-primary" title="Güncelle"><i class="bi bi-pencil"></i></a>
                  </div>
                </div>

                <!-- Görev 3 -->
                <div class="task-item">
                  <div class="task-priority low"></div>
                  <div class="task-content">
                    <h6 class="task-title">Dokümantasyon Hazırlama</h6>
                    <div class="task-details">
                      <span class="task-project"><i class="bi bi-kanban"></i> API Entegrasyonu</span>
                      <span class="task-deadline"><i class="bi bi-calendar-event"></i> 5 Haziran 2025</span>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                  <div class="task-actions">
                    <a href="#" class="btn btn-sm btn-success" title="Tamamla"><i class="bi bi-check-lg"></i></a>
                    <a href="#" class="btn btn-sm btn-primary" title="Güncelle"><i class="bi bi-pencil"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Projelerim ve Son Etkinlikler -->
      <div class="row">
        <!-- Projelerim -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Projelerim</h5>
              <a href="../projects/my-projects.html" class="btn btn-sm btn-primary">Tümünü Gör</a>
            </div>
            <div class="card-body">
              <div class="project-list">
                <!-- Proje 1 -->
                <div class="project-item">
                  <div class="project-info">
                    <h6 class="project-name">Web Sitesi Yenileme</h6>
                    <div class="project-details">
                                                <span class="project-deadline">
                                                    <i class="bi bi-calendar-event"></i> Bitiş: 15 Haziran 2025
                                                </span>
                      <span class="project-manager">
                                                    <i class="bi bi-person"></i> Yönetici: Mehmet Aydın
                                                </span>
                    </div>
                  </div>
                  <div class="project-progress">
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">75% tamamlandı</small>
                  </div>
                </div>

                <!-- Proje 2 -->
                <div class="project-item">
                  <div class="project-info">
                    <h6 class="project-name">API Entegrasyonu</h6>
                    <div class="project-details">
                                                <span class="project-deadline">
                                                    <i class="bi bi-calendar-event"></i> Bitiş: 10 Haziran 2025
                                                </span>
                      <span class="project-manager">
                                                    <i class="bi bi-person"></i> Yönetici: Zeynep Yıldız
                                                </span>
                    </div>
                  </div>
                  <div class="project-progress">
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-info" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted">60% tamamlandı</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Son Etkinlikler -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Son Etkinlikler</h5>
            </div>
            <div class="card-body">
              <ul class="activity-list">
                <li class="activity-item">
                  <div class="activity-icon bg-success">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Görev Tamamlandı</div>
                    <div class="activity-text">Login sayfası tasarımı tamamlandı</div>
                    <div class="activity-time">Bugün, 10:30</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-primary">
                    <i class="bi bi-plus-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Yeni Görev</div>
                    <div class="activity-text">Responsive tasarım görevine atandınız</div>
                    <div class="activity-time">Dün, 15:45</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-info">
                    <i class="bi bi-chat-dots"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Yeni Yorum</div>
                    <div class="activity-text">Mehmet Aydın "Frontend Geliştirme" görevine yorum ekledi</div>
                    <div class="activity-time">Dün, 14:20</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-warning">
                    <i class="bi bi-exclamation-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Görev Güncellendi</div>
                    <div class="activity-text">"Dokümantasyon Hazırlama" görevinin son tarihi güncellendi</div>
                    <div class="activity-time">2 gün önce, 11:30</div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="dashboard-footer">
      <p>&copy; 2025 Görev Takip Sistemi. Tüm hakları saklıdır.</p>
    </footer>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script src="../assets/js/main.js"></script>
<script>
  // Member Dashboard verilerini yükle
  async function loadMemberDashboard() {
    try {
      document.querySelector('.content-container').style.opacity = '0.7';

      const response = await AuthUtils.makeAuthenticatedRequest(`${API_BASE_URL}/dashboard/member`);
      const result = await response.json();

      if (result.success) {
        updateMemberStats(result.data.stats);
        updateActiveTasks(result.data.activeTasks);
        updateUserProjects(result.data.projects);
        updateUserActivities(result.data.activities);
      }
    } catch (error) {
      console.error('Dashboard loading error:', error);
      showError(document.querySelector('.content-container'), 'Dashboard verileri yüklenemedi');
    } finally {
      document.querySelector('.content-container').style.opacity = '1';
    }
  }

  // Member istatistiklerini güncelle
  function updateMemberStats(stats) {
    document.querySelector('.stats-card:nth-child(1) .stats-card-value').textContent = stats.projects;
    document.querySelector('.stats-card:nth-child(2) .stats-card-value').textContent = stats.pendingTasks;
    document.querySelector('.stats-card:nth-child(3) .stats-card-value').textContent = stats.completedTasks;
    document.querySelector('.stats-card:nth-child(4) .stats-card-value').textContent = stats.totalHours + 's';
  }

  // Aktif görevleri güncelle
  function updateActiveTasks(tasks) {
    const tasksContainer = document.querySelector('.task-list');

    if (!tasks || tasks.length === 0) {
      showEmpty(tasksContainer, 'Henüz aktif göreviniz bulunmuyor');
      return;
    }

    const tasksHTML = tasks.map(task => {
      const priorityClass = {
        'high': 'high',
        'medium': 'medium',
        'low': 'low'
      }[task.priority] || 'medium';

      // Görev progresini hesapla (örnek olarak priority'ye göre)
      const progress = task.status === 'in_progress' ? 50 :
              task.status === 'completed' ? 100 : 0;

      return `
      <div class="task-item">
        <div class="task-priority ${priorityClass}"></div>
        <div class="task-content">
          <h6 class="task-title">
            <a href="../tasks/detail.html?id=${task.id}">${task.title}</a>
          </h6>
          <div class="task-details">
            <span class="task-project">
              <i class="bi bi-kanban"></i> ${task.project_name}
            </span>
            <span class="task-deadline">
              <i class="bi bi-calendar-event"></i> ${formatDate(task.due_date)}
            </span>
          </div>
          <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar ${progress < 30 ? 'bg-danger' : progress < 70 ? 'bg-warning' : 'bg-success'}"
                 role="progressbar" style="width: ${progress}%;"
                 aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="task-actions">
          <a href="../tasks/detail.html?id=${task.id}" class="btn btn-sm btn-primary" title="Görüntüle">
            <i class="bi bi-eye"></i>
          </a>
          <a href="../tasks/edit.html?id=${task.id}" class="btn btn-sm btn-primary" title="Güncelle">
            <i class="bi bi-pencil"></i>
          </a>
        </div>
      </div>
    `;
    }).join('');

    tasksContainer.innerHTML = tasksHTML;
  }

  // Kullanıcı projelerini güncelle
  function updateUserProjects(projects) {
    const projectsContainer = document.querySelector('.project-list');

    if (!projects || projects.length === 0) {
      showEmpty(projectsContainer, 'Henüz projeye atanmamışsınız');
      return;
    }

    const projectsHTML = projects.map(project => {
      const progress = project.task_count > 0 ?
              Math.round((project.completed_tasks / project.task_count) * 100) : 0;

      return `
      <div class="project-item">
        <div class="project-info">
          <h6 class="project-name">
            <a href="../projects/detail.html?id=${project.id}">${project.name}</a>
          </h6>
          <div class="project-details">
            <span class="project-deadline">
              <i class="bi bi-calendar-event"></i> Bitiş: ${formatDate(project.end_date)}
            </span>
            <span class="project-manager">
              <i class="bi bi-person"></i> Yönetici: ${project.manager_first_name} ${project.manager_last_name}
            </span>
          </div>
        </div>
        <div class="project-progress">
          <div class="progress" style="height: 8px;">
            <div class="progress-bar ${progress < 30 ? 'bg-danger' : progress < 70 ? 'bg-warning' : 'bg-success'}"
                 role="progressbar" style="width: ${progress}%;"
                 aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <small class="text-muted">${progress}% tamamlandı</small>
        </div>
      </div>
    `;
    }).join('');

    projectsContainer.innerHTML = projectsHTML;
  }

  // Kullanıcı aktivitelerini güncelle
  function updateUserActivities(activities) {
    const activitiesContainer = document.querySelector('.activity-list');

    if (!activities || activities.length === 0) {
      showEmpty(activitiesContainer, 'Henüz aktivite bulunmuyor');
      return;
    }

    const activitiesHTML = activities.map(activity => {
      const icon = getActivityIcon(activity.action);
      return `
      <li class="activity-item">
        <div class="activity-icon ${icon.class}">
          <i class="${icon.icon}"></i>
        </div>
        <div class="activity-content">
          <div class="activity-title">${getActivityTitle(activity.action)}</div>
          <div class="activity-text">${activity.description}</div>
          <div class="activity-time">${formatDateTime(activity.created_at)}</div>
        </div>
      </li>
    `;
    }).join('');

    activitiesContainer.innerHTML = activitiesHTML;
  }

  // Sayfa yüklendiğinde dashboard'ı yükle
  document.addEventListener('DOMContentLoaded', function() {
    const currentUser = AuthUtils.getCurrentUser();
    if (!currentUser || currentUser.role !== 'member') {
      window.location.href = '/index.html';
      return;
    }

    loadMemberDashboard();
  });
</script>
</body>
</html>