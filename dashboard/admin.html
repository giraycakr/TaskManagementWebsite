<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Görev Takip Sistemi - Admin Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Custom CSS -->

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="brand-container">
      <div class="brand-logo">T</div>
      <h4 class="brand-name">TaskTrack</h4>
    </div>

    <div class="menu-container">
      <ul class="nav-menu">
        <li class="menu-item active">
          <a href="./admin.html">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="../projects/list.html">
            <i class="bi bi-kanban"></i>
            <span>Projeler</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="../tasks/list.html">
            <i class="bi bi-list-task"></i>
            <span>Görevler</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="../users/list.html">
            <i class="bi bi-people"></i>
            <span>Kullanıcılar</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="#" id="logoutBtn">
            <i class="bi bi-box-arrow-right"></i>
            <span>Çıkış Yap</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="menu-toggle" id="menu-toggle">
        <i class="bi bi-list"></i>
      </div>

      <div class="header-right">
        <div class="notifications">
          <i class="bi bi-bell"></i>
          <span class="badge">3</span>
        </div>

        <div class="user-profile">
          <div class="profile-img">
            <span>A</span>
          </div>
          <div class="profile-info">
            <span class="user-name">Admin</span>
            <span class="user-role">Yönetici</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="content-container">
      <!-- Sayfa başlığı -->
      <div class="content-header">
        <h2 class="page-title">Admin Dashboard</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Ana Sayfa</a></li>
            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
          </ol>
        </nav>
      </div>

      <!-- İstatistik Kartları -->
      <div class="row">
        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-primary">
                <i class="bi bi-people-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Toplam Kullanıcı</h5>
                <h3 class="stats-card-value">24</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-success">
                <i class="bi bi-kanban-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Aktif Projeler</h5>
                <h3 class="stats-card-value">8</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-warning">
                <i class="bi bi-list-task"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Bekleyen Görevler</h5>
                <h3 class="stats-card-value">16</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
          <div class="stats-card">
            <div class="stats-card-body">
              <div class="stats-card-icon bg-info">
                <i class="bi bi-check-circle-fill"></i>
              </div>
              <div class="stats-card-content">
                <h5 class="stats-card-title">Tamamlanan Görevler</h5>
                <h3 class="stats-card-value">42</h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Son Etkinlikler ve Projeler Bölümü -->
      <div class="row">
        <!-- Son Etkinlikler -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Son Etkinlikler</h5>
              <a href="../activities.html" class="btn btn-sm btn-primary">Tümünü Gör</a>
            </div>
            <div class="card-body">
              <ul class="activity-list">
                <li class="activity-item">
                  <div class="activity-icon bg-primary">
                    <i class="bi bi-person-plus"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Yeni Kullanıcı</div>
                    <div class="activity-text">Ahmet Yılmaz sisteme kayıt oldu</div>
                    <div class="activity-time">Bugün, 14:45</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-success">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Görev Tamamlandı</div>
                    <div class="activity-text">Frontend geliştirme görevi tamamlandı</div>
                    <div class="activity-time">Bugün, 12:30</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-warning">
                    <i class="bi bi-exclamation-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Görev Güncellendi</div>
                    <div class="activity-text">Veritabanı optimizasyonu ertelendi</div>
                    <div class="activity-time">Dün, 16:20</div>
                  </div>
                </li>
                <li class="activity-item">
                  <div class="activity-icon bg-info">
                    <i class="bi bi-plus-circle"></i>
                  </div>
                  <div class="activity-content">
                    <div class="activity-title">Yeni Proje</div>
                    <div class="activity-text">E-ticaret platformu projesi oluşturuldu</div>
                    <div class="activity-time">Dün, 09:15</div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Son Projeler -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Son Projeler</h5>
              <a href="../projects/list.html" class="btn btn-sm btn-primary">Tümünü Gör</a>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                  <tr>
                    <th>Proje Adı</th>
                    <th>Proje Sahibi</th>
                    <th>İlerleme</th>
                    <th>Durum</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td>Web Sitesi Yenileme</td>
                    <td>Mehmet Aydın</td>
                    <td>
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small class="text-muted">75%</small>
                    </td>
                    <td><span class="badge bg-success">Aktif</span></td>
                  </tr>
                  <tr>
                    <td>Mobil Uygulama Geliştirme</td>
                    <td>Ayşe Kaya</td>
                    <td>
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 45%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small class="text-muted">45%</small>
                    </td>
                    <td><span class="badge bg-warning">Devam Ediyor</span></td>
                  </tr>
                  <tr>
                    <td>Veritabanı Optimizasyonu</td>
                    <td>Ali Demir</td>
                    <td>
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small class="text-muted">15%</small>
                    </td>
                    <td><span class="badge bg-danger">Beklemede</span></td>
                  </tr>
                  <tr>
                    <td>API Entegrasyonu</td>
                    <td>Zeynep Yıldız</td>
                    <td>
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small class="text-muted">60%</small>
                    </td>
                    <td><span class="badge bg-info">Aktif</span></td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="dashboard-footer">
      <p>&copy; 2025 Görev Takip Sistemi. Tüm hakları saklıdır.</p>
    </footer>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script src="../assets/js/main.js"></script>
<script>
  // Admin Dashboard verilerini yükle
  async function loadAdminDashboard() {
    try {
      // Loading state
      document.querySelector('.content-container').style.opacity = '0.7';

      // API'den dashboard verilerini al
      const response = await AuthUtils.makeAuthenticatedRequest(`${API_BASE_URL}/dashboard/admin`);
      const result = await response.json();

      if (result.success) {
        updateDashboardStats(result.data.stats);
        updateActivitiesList(result.data.activities);
        updateRecentProjects(result.data.recentProjects);
      }
    } catch (error) {
      console.error('Dashboard loading error:', error);
      showError(document.querySelector('.content-container'), 'Dashboard verileri yüklenemedi');
    } finally {
      document.querySelector('.content-container').style.opacity = '1';
    }
  }

  // İstatistikleri güncelle
  function updateDashboardStats(stats) {
    // Toplam kullanıcı
    document.querySelector('.stats-card:nth-child(1) .stats-card-value').textContent = stats.totalUsers;

    // Aktif projeler
    document.querySelector('.stats-card:nth-child(2) .stats-card-value').textContent = stats.activeProjects;

    // Bekleyen görevler
    document.querySelector('.stats-card:nth-child(3) .stats-card-value').textContent = stats.pendingTasks;

    // Tamamlanan görevler
    document.querySelector('.stats-card:nth-child(4) .stats-card-value').textContent = stats.completedTasks;
  }

  // Aktiviteleri güncelle
  function updateActivitiesList(activities) {
    const activitiesContainer = document.querySelector('.activity-list');

    if (!activities || activities.length === 0) {
      showEmpty(activitiesContainer, 'Henüz aktivite bulunmuyor');
      return;
    }

    const activitiesHTML = activities.map(activity => {
      const icon = getActivityIcon(activity.action);
      return `
      <li class="activity-item">
        <div class="activity-icon ${icon.class}">
          <i class="${icon.icon}"></i>
        </div>
        <div class="activity-content">
          <div class="activity-title">${getActivityTitle(activity.action)}</div>
          <div class="activity-text">${activity.description}</div>
          <div class="activity-time">${formatDateTime(activity.created_at)}</div>
        </div>
      </li>
    `;
    }).join('');

    activitiesContainer.innerHTML = activitiesHTML;
  }

  // Son projeleri güncelle
  function updateRecentProjects(projects) {
    const projectsContainer = document.querySelector('.table tbody');

    if (!projects || projects.length === 0) {
      projectsContainer.innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-muted">Henüz proje bulunmuyor</td>
      </tr>
    `;
      return;
    }

    const projectsHTML = projects.map(project => {
      const progress = project.task_count > 0 ?
              Math.round((project.completed_tasks / project.task_count) * 100) : 0;

      return `
      <tr>
        <td>
          <a href="../projects/detail.html?id=${project.id}" class="text-primary fw-bold">
            ${project.name}
          </a>
        </td>
        <td>${project.manager_first_name} ${project.manager_last_name}</td>
        <td>
          <div class="progress" style="height: 5px;">
            <div class="progress-bar ${progress < 30 ? 'bg-danger' : progress < 70 ? 'bg-warning' : 'bg-success'}"
                 role="progressbar" style="width: ${progress}%;"
                 aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
          <small class="text-muted">${progress}%</small>
        </td>
        <td>${getStatusBadge(project.status, 'project')}</td>
      </tr>
    `;
    }).join('');

    projectsContainer.innerHTML = projectsHTML;
  }

  // Aktivite ikonlarını getir
  function getActivityIcon(action) {
    const icons = {
      'create': { class: 'bg-primary', icon: 'bi bi-plus-circle' },
      'update': { class: 'bg-warning', icon: 'bi bi-pencil' },
      'delete': { class: 'bg-danger', icon: 'bi bi-trash' },
      'login': { class: 'bg-success', icon: 'bi bi-box-arrow-in-right' },
      'logout': { class: 'bg-info', icon: 'bi bi-box-arrow-right' }
    };

    return icons[action] || icons['update'];
  }

  // Aktivite başlığını getir
  function getActivityTitle(action) {
    const titles = {
      'create': 'Oluşturuldu',
      'update': 'Güncellendi',
      'delete': 'Silindi',
      'login': 'Giriş Yapıldı',
      'logout': 'Çıkış Yapıldı'
    };

    return titles[action] || 'Aktivite';
  }

  // Sayfa yüklendiğinde dashboard'ı yükle
  document.addEventListener('DOMContentLoaded', function() {
    // Eğer admin değilse yönlendir
    const currentUser = AuthUtils.getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
      window.location.href = '/index.html';
      return;
    }

    loadAdminDashboard();
  });
</script>
</body>
</html>